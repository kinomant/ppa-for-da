* Создайте [виртуальное окружение](https://docs.python.org/3/library/venv.html) и активируйте его:
```shell script
python3 -m venv venv
```

* Активируйте его:
```shell script
source venv/bin/activate
```
или в Windowns
```shell script
source venv/Scripts/activate
```

* Обновите pip до последней версии:
```shell script
pip install --upgrade pip
```
* Установите зависимости:
```shell script
pip install -r requirements.txt
```

Для выполнения заданий выполните:

`docker compose up -d`

Если у Вас не установлен python 3.8 то самое время сделать это. 

- Airflow
	- `localhost:3000/airflow`
- БД
	- `jovyan:jovyan@localhost:15432/de`
	- в Airflow порт 5432
- Metabase
    - `http://localhost:3333/` 

## Начало работы

Подключитесь к Postrges и создайте модель для stg-слоя (пример скрипта sql/stg_ddl.sql)

Через Airflow UI создайте подключение к БД (admin - connections), назовите его PG_WAREHOUSE_CONNECTION (как в скрипте dags/get_data.py).

Запустите dag api_to_stg и убедитесь в том, что dag завершен успешно.

## Задание 2 

Здесь описан один из возможных вариантов выполнения:

- Удалите таблицу из слоя stg и создайте новую модель,
- доработайте модель на stg с учетом эндпойнтов для получения информации о структурных подразделениях и статусах, а также с учетом json'ов c учебными планами;
- доработайте модель на stg с учетом SCD2;
- доработайте скрипт из dag'а api_to_stg для скачивания аннотаций (нужно скачивать все страницы и раскидывать по разным моделям);
- доработайте скрипт из dag'а api_to_stg для сбора данных по всем эндпойнтам;
- создайте модель данных для слоя ddl, учивающую все необходимые поля для построения дэшборда;
- создайте скрипт для переноса данных из stg на ddl;
- спроектируйте модель для cdm (слой витрин);
- подключите Metabase к модели на слое cdm (при первом подключении нужно зарегистрироваться, хост:порт de-pg-cr-af:5432);
- сформируйте дэшборд в соответствии с требованиями.

## Эндпойнты

- Структные подразделения: https://op.itmo.ru/api/record/structural/workprogram (см. dags/get_su.py)
- Рабочие программы и статусы: https://op.itmo.ru/api/record/academic_plan/academic_wp_description/all (см. dag/get_wp_descriptions.py)
- Учебные планы: https://disc.itmo.su/api/v1/academic_plans/' (аутентификация для эндпойнта по запросу, как альтернативу можно использовать данные из папки ./data) (см. dags/get_up_descriptions.py)


## Замечание по поводу проектирования слоёв
Staging — первый слой в хранилище. Это значит, что данные из систем-источников сначала попадают именно в него. Основные функции staging-области:
- Сбор сырых данных из нескольких источников 
- Снятие нагрузки с систем-источников 


С какого слоя начать проектирование? Определиться с порядком создания слоёв помогут концепции Ральфа Кимбалла и Билла Инмона о проектировании корпоративных хранилищ данных. Принципиальное отличие подходов в том, что считать более важным. Эти подходы часто сравнивают, но в реальности в чистом виде их используют очень редко, поэтому проще каждый раз отталкиваться от задачи.

### Подход Ральфа Кимбалла
Кимбалл говорит, что важнее всего — потребности бизнеса, а значит, проектирование нужно осуществлять начиная с витрин. Всё остальное хранилище должно быть нацелено на их обслуживание.
В первую очередь вы должны выяснить у заказчика, какие витрины и с какими показателями нужны. Спроектировав и задокументировав витрины, вы можете начать работу с детальным слоем, который будет хранить только данные, необходимые для обслуживания витрин.

Преимущества метода:
- Быстрая реализация, так как исходим от конкретных потребностей бизнеса.
- Используется простая, понятная и эффективная модель «звезда», когда это возможно.
- Поддерживать работу хранилища данных сможет небольшое количество специалистов.

Недостатки метода:
- Нет единого источника истинной информации, потому что данные интегрированы, то есть связаны между собой, не полностью.
- Добавление столбцов в таблицу фактов может снизить эффективность — придётся перестраивать таблицу, чтобы удовлетворить требованиям модели данных, и таблица будет перегружена.
- Хранилище не удовлетворяет запросам всей компании, потому что изначально было ориентировано на конкретные бизнес-процессы.

### Подход Билла Инмона
В подходе Билла Инмона важнее корпоративная модель данных. Сперва мы должны определить предметные области бизнеса и спроектировать хранилище, которое полностью их описывает. При таком подходе сначала строится нормализованная модель данных и уже на её основе — витрины.

Преимущества метода:
- DDS — единственный источник данных для витрин, а также корректной информации для компании.
- Все данные в хранилище интегрированы.
- Понятная последовательность этапов в бизнес-процессах, поскольку они изображены подробно.
- Возможность составлять разнообразные отчёты в зависимости от требований.

Недостатки метода:
- Более сложная модель данных.
- Компании необходима компетенция в моделировании данных, это сложная и дорогостоящая задача.
- Первоначальная настройка занимает продолжительное время.
- Дополнительная работа с ETL-процессом.
- Чтобы поддерживать работу хранилища, нужно большое количество специалистов.
